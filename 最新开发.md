# 消息中心系统 - 开发记录

**日期**: 2026-01-26
**分支**: `claude/message-center-system-QZWL7`

---

## 一、需求概述

搭建统一的消息收纳箱，解决此前系统通知分散（有的在弹窗，有的没提示）的问题，作为用户侧信息的唯一聚合入口。

### 核心目标

- 四类消息分类：资产变动、服务进度、系统公告、内容/活动推送
- 红点强提醒（Badge）：未读消息常驻红点，进入列表页后消除
- 列表展示：按时间倒序，不同分类匹配不同左侧 Icon 图标

---

## 二、架构设计

采用项目现有的 **Service-DAO-Model** 分层架构，两张数据表配合实现：

| 表名 | 用途 |
|------|------|
| `eb_message_center` | 消息主表，存储定向消息(uid>0)和广播消息(uid=0) |
| `eb_message_center_read` | 广播消息已读记录表，追踪每个用户对广播消息的阅读状态 |

### 设计亮点

- **定向消息**（资产变动、服务进度）：`uid` 指向特定用户，`look` 字段直接标记已读状态
- **广播消息**（系统公告、内容推送）：`uid=0`，通过独立的 `message_center_read` 表追踪每位用户的已读记录，避免为每个用户复制一条消息记录

---

## 三、消息分类

| 分类 | category 值 | 图标 Icon | 使用场景 |
|------|------------|-----------|----------|
| 资产变动 | 1 | `lightning` (闪电) | 能量收支明细，如"邀请好友成功 +30 能量"、"兑换码核销 +299 能量" |
| 服务进度 | 2 | `document` (文档) | 报告生成状态，如"您的 Plan B 深度诊断报告已生成" |
| 系统公告 | 3 | `megaphone` (喇叭) | 版本更新日志、隐私协议修订等，支持富文本展示 |
| 内容/活动推送 | 4 | `activity` (活动) | 公众号文章、直播预告，支持配置外部跳转链接 |

---

## 四、数据库设计

### 4.1 消息主表 `eb_message_center`

```sql
CREATE TABLE `eb_message_center` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '消息ID',
  `uid` int(11) unsigned NOT NULL DEFAULT 0 COMMENT '接收用户ID，0表示广播消息',
  `category` tinyint(1) unsigned NOT NULL DEFAULT 1 COMMENT '消息分类：1=资产变动,2=服务进度,3=系统公告,4=内容/活动推送',
  `title` varchar(256) NOT NULL DEFAULT '' COMMENT '消息标题',
  `content` text COMMENT '消息内容（系统公告支持富文本）',
  `icon_type` varchar(50) NOT NULL DEFAULT 'default' COMMENT '左侧图标类型',
  `jump_url` varchar(512) NOT NULL DEFAULT '' COMMENT '跳转链接',
  `jump_type` tinyint(1) unsigned NOT NULL DEFAULT 0 COMMENT '跳转类型：0=无跳转,1=内部页面,2=外部链接',
  `extra_data` text COMMENT '附加数据JSON',
  `is_broadcast` tinyint(1) unsigned NOT NULL DEFAULT 0 COMMENT '是否广播消息：0=定向,1=广播',
  `look` tinyint(1) unsigned NOT NULL DEFAULT 0 COMMENT '已读状态（仅定向消息）',
  `status` tinyint(1) unsigned NOT NULL DEFAULT 1 COMMENT '状态：0=禁用,1=启用',
  `is_del` tinyint(1) unsigned NOT NULL DEFAULT 0 COMMENT '是否删除',
  `admin_id` int(11) unsigned NOT NULL DEFAULT 0 COMMENT '创建管理员ID',
  `add_time` int(11) unsigned NOT NULL DEFAULT 0 COMMENT '创建时间戳',
  PRIMARY KEY (`id`),
  KEY `idx_uid` (`uid`),
  KEY `idx_category` (`category`),
  KEY `idx_uid_category_del` (`uid`, `category`, `is_del`),
  KEY `idx_broadcast_status` (`is_broadcast`, `status`, `is_del`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息中心主表';
```

### 4.2 广播已读记录表 `eb_message_center_read`

```sql
CREATE TABLE `eb_message_center_read` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `message_id` int(11) unsigned NOT NULL DEFAULT 0 COMMENT '消息ID',
  `uid` int(11) unsigned NOT NULL DEFAULT 0 COMMENT '用户ID',
  `add_time` int(11) unsigned NOT NULL DEFAULT 0 COMMENT '阅读时间戳',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_message_uid` (`message_id`, `uid`),
  KEY `idx_uid` (`uid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='广播消息已读记录表';
```

**SQL 文件位置**: `public/install/message_center.sql`

---

## 五、新增文件清单（10个）

### 5.1 Model 层（2个）

| 文件路径 | 说明 |
|----------|------|
| `app/model/gxhc/MessageCenter.php` | 消息主表模型，含分类常量、图标映射、搜索器 |
| `app/model/gxhc/MessageCenterRead.php` | 广播已读记录模型 |

### 5.2 DAO 层（2个）

| 文件路径 | 说明 |
|----------|------|
| `app/dao/gxhc/MessageCenterDao.php` | 消息数据访问，含用户消息查询、未读统计、批量标记已读 |
| `app/dao/gxhc/MessageCenterReadDao.php` | 已读记录数据访问，含批量标记、未读计数 |

### 5.3 Service 层（1个）

| 文件路径 | 说明 |
|----------|------|
| `app/services/gxhc/MessageCenterServices.php` | 核心业务逻辑：用户端+管理端+系统发送 |

### 5.4 Controller 层（2个）

| 文件路径 | 说明 |
|----------|------|
| `app/api/controller/v1/gxhc/MessageCenterController.php` | 用户端 API（5个接口） |
| `app/adminapi/controller/v1/gxhc/MessageCenter.php` | 管理后台 API（7个接口） |

### 5.5 路由（2个文件修改）

| 文件路径 | 说明 |
|----------|------|
| `app/api/route/v1.php` | 新增用户消息中心路由 |
| `app/adminapi/route/gxhc.php` | 新增管理后台消息中心路由 |

### 5.6 SQL（1个）

| 文件路径 | 说明 |
|----------|------|
| `public/install/message_center.sql` | 两张数据表建表语句 |

---

## 六、API 接口清单

### 6.1 用户端接口（需登录认证）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/message_center/list` | 消息列表 |
| GET | `/api/message_center/detail/:id` | 消息详情（自动标记已读） |
| GET | `/api/message_center/unread_count` | 未读消息数量（红点 Badge） |
| POST | `/api/message_center/mark_read` | 标记已读 |
| POST | `/api/message_center/delete/:id` | 删除消息 |

#### 消息列表

```
GET /api/message_center/list?category=0&page=1&limit=10
```

参数：
- `category`: 分类筛选，0=全部，1=资产变动，2=服务进度，3=系统公告，4=内容推送
- `page`: 页码
- `limit`: 每页数量

响应示例：
```json
{
  "status": 200,
  "msg": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "uid": 100,
        "category": 1,
        "category_name": "资产变动",
        "title": "邀请好友成功 +30 能量",
        "content_summary": "您成功邀请好友张三注册...",
        "icon_type": "lightning",
        "jump_url": "/pages/task/index",
        "jump_type": 1,
        "is_read": 0,
        "is_broadcast": 0,
        "add_time_format": "2026-01-26 14:30:00",
        "time_ago": "5分钟前",
        "extra_data": null
      }
    ],
    "count": 15
  }
}
```

#### 未读消息数量（红点 Badge）

```
GET /api/message_center/unread_count
```

响应示例：
```json
{
  "status": 200,
  "msg": "success",
  "data": {
    "total": 5,
    "has_unread": true,
    "detail": {
      "direct": 3,
      "broadcast": 2
    }
  }
}
```

#### 标记已读

```
POST /api/message_center/mark_read
```

参数：
- `id`: 消息ID，0=标记全部已读
- `category`: 分类，0=全部分类

#### 消息详情

```
GET /api/message_center/detail/:id
```

查看详情时自动标记为已读，返回完整消息内容（系统公告含富文本）。

### 6.2 管理后台接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/adminapi/message_center/list` | 消息列表 |
| GET | `/adminapi/message_center/detail/:id` | 消息详情 |
| POST | `/adminapi/message_center/create` | 创建消息 |
| PUT | `/adminapi/message_center/update/:id` | 更新消息 |
| DELETE | `/adminapi/message_center/delete/:id` | 删除消息 |
| PUT | `/adminapi/message_center/set_status/:id` | 修改状态 |
| GET | `/adminapi/message_center/overview` | 统计概览 |

#### 创建消息

```
POST /adminapi/message_center/create
```

请求参数：
```json
{
  "category": 3,
  "title": "V2.0版本更新公告",
  "content": "<h3>新增功能</h3><p>消息中心上线，统一管理所有通知...</p>",
  "icon_type": "megaphone",
  "jump_url": "",
  "jump_type": 0,
  "extra_data": "",
  "is_broadcast": 1,
  "uid": 0,
  "status": 1
}
```

字段说明：
- `category`: 1=资产变动, 2=服务进度, 3=系统公告, 4=内容推送
- `is_broadcast`: 0=定向（需指定uid）, 1=广播全部用户
- `jump_type`: 0=无跳转, 1=内部页面, 2=外部链接
- `icon_type`: lightning/document/megaphone/activity/default（留空则自动匹配分类）

---

## 七、业务集成方式

其他业务模块向消息中心发送通知：

```php
// 获取服务实例
$messageCenterServices = app()->make(\app\services\gxhc\MessageCenterServices::class);

// 1. 资产变动通知（定向 -> 特定用户）
$messageCenterServices->sendAssetChangeMessage(
    $uid,                              // 目标用户ID
    '邀请好友成功 +30 能量',             // 标题
    '您成功邀请好友张三注册，获得30能量奖励', // 内容
    '/pages/task/index',               // 跳转路径（可选）
    1,                                 // 跳转类型：1=内部页面
    ['invite_uid' => 200]              // 附加数据（可选）
);

// 2. 服务进度通知（定向 -> 特定用户）
$messageCenterServices->sendServiceProgressMessage(
    $uid,
    '您的 Plan B 深度诊断报告已生成',
    '报告已完成生成，点击查看详细分析结果',
    '/pages/bp/result?id=123',
    1,
    ['report_id' => 123]
);

// 3. 系统公告（广播 -> 所有用户）
$messageCenterServices->sendSystemAnnouncement(
    'V2.0版本更新公告',
    '<h3>新增功能</h3><p>消息中心上线...</p>',  // 支持富文本
    $adminId                                    // 管理员ID（可选）
);

// 4. 内容/活动推送（广播 -> 所有用户，含外部链接）
$messageCenterServices->sendContentPush(
    '直播预告：创业融资实战分享',
    '本周四晚8点，特邀嘉宾分享创业融资经验',
    'https://mp.weixin.qq.com/s/xxx',  // 外部跳转链接
    2,                                  // 跳转类型：2=外部链接
    $adminId,
    ['live_id' => 456]
);
```

---

## 八、交互与提醒机制

### 8.1 红点 Badge 逻辑

前端调用 `GET /api/message_center/unread_count` 获取未读数：

- `total > 0` 时显示数字红点
- 用户进入消息列表页后，调用 `POST /api/message_center/mark_read` 标记全部已读
- 红点消失条件：`total == 0`

### 8.2 列表展示逻辑

- 按时间倒序排列（`add_time DESC`）
- 定向消息和广播消息合并展示
- 每条消息左侧显示分类对应的 Icon：
  - `lightning` = 闪电（资产变动）
  - `document` = 文档（服务进度）
  - `megaphone` = 喇叭（系统公告）
  - `activity` = 活动（内容推送）
- 未读消息可通过 `is_read` 字段区分样式
- 列表页显示内容摘要（前100字符），详情页显示完整内容

### 8.3 推荐的前端调用时机

| 场景 | 调用接口 |
|------|----------|
| App/小程序启动时 | `unread_count` -> 更新底部导航/铃铛红点 |
| 进入消息中心列表页 | `list` -> 渲染列表 |
| 点击某条消息 | `detail/:id` -> 显示详情（自动标记已读） |
| 点击"全部已读" | `mark_read` (id=0) -> 清除所有未读 |
| 定时轮询（可选） | 每30秒调用 `unread_count` 更新红点 |

---

## 九、部署注意事项

1. **执行建表 SQL**: 上线前执行 `public/install/message_center.sql`
2. **接口认证**: 用户端接口需要登录认证（AuthTokenMiddleware），管理端需要管理员认证
3. **数据表前缀**: SQL 文件中使用 `eb_` 前缀，请根据实际环境配置调整

---

*开发记录时间：2026-01-26*
